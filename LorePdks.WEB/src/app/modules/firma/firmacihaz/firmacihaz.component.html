<div class="firmacihaz-container">  <div class="firmacihaz-header">
    <h1>Firma Cihaz Yönetimi</h1>
    <div class="firmacihaz-actions">      <div class="firma-filter">
        <app-select
          title="Firma"
          [itemListDto$]="firmaListDto$"
          [selectedValue]="selectedFirma?.eid"
          placeholder="Firmaya Göre Filtrele"
          (selectionChange)="onFirmaChange($event)">
        </app-select>
      </div>
      
      <app-button
        name="Yeni Cihaz"
        icon="pi pi-plus"
        class="p-button-sm"
        (onClick)="openAddFirmaCihazModal()">
      </app-button>
    </div>
  </div>
  
  <div class="firmacihaz-content" style="width: 100%;">
    <app-data-grid
      [data]="firmaCihazList"
      [columns]="columns"
      [loading]="loading"
      headerTitle="Firma Cihaz Listesi"
      [responsive]="true"
      [tableStyle]="{'width': '100%', 'min-width': '800px'}"
      [actionButtons]="actionButtons"
      (rowAction)="onRowAction($event)">
    </app-data-grid>
  </div>
  
  <!-- Firma Cihaz Ekleme/Düzenleme Modalı -->
  <app-modal
    [(visible)]="firmaCihazModalVisible"
    [title]="firmaCihazModel.eid ? 'Cihaz Düzenle' : 'Yeni Cihaz'"
    [width]="'500px'"
    (save)="saveFirmaCihaz()"
    (visibleChange)="!firmaCihazModalVisible && onFirmaCihazModalClosed()">    <div class="firmacihaz-form">
      <div class="form-group">
        <app-select
          title="Firma"
          [itemListDto$]="firmaListDto$"
          [selectedValue]="firmaCihazModel.firmaDto?.eid"
          placeholder="Firma seçiniz"
          [isRequired]="true"
          (selectionChange)="onModalFirmaChange($event)">
        </app-select>
      </div>      <div class="form-group">
        <app-select
          title="Cihaz Tipi"
          [itemListDto$]="cihazTipleriListDto$"
          [selectedValue]="firmaCihazModel.firmaCihazTipKodDto?.id"
          placeholder="Cihaz tipi seçiniz"
          [isRequired]="true"
          [class]="'z-3'"
          (selectionChange)="onModalCihazTipChange($event)">
        </app-select>
        <!-- Debug bilgisi - cihaz tiplerini kontrol için -->
        <small *ngIf="false" class="text-muted">
          Seçilen ID: {{firmaCihazModel.firmaCihazTipKodDto?.id}}
        </small>
      </div>
        <app-text-input
        title="Cihaz Adı"
        [value]="firmaCihazModel.ad || ''"
        (valueChange)="firmaCihazModel.ad = $event"
        placeholder="Cihaz adını giriniz"
        [isRequired]="true">
      </app-text-input>      <app-text-input
        title="Cihaz ID"
        type="number"
        [value]="firmaCihazModel.cihazMakineGercekId != null ? firmaCihazModel.cihazMakineGercekId.toString() : ''"
        (valueChange)="firmaCihazModel.cihazMakineGercekId = parseFloat($event)"
        placeholder="Cihaz ID'sini giriniz"
        [isRequired]="true">
      </app-text-input>
        <app-text-input
        title="Açıklama"
        [value]="firmaCihazModel.aciklama || ''"
        (valueChange)="firmaCihazModel.aciklama = $event"
        placeholder="Açıklama giriniz">
      </app-text-input>    </div>
  </app-modal>
  <!-- Log Parser Ayarları Modalı -->
  <app-modal
    [(visible)]="logParserModalVisible"
    [title]="'Log Parser Ayarları - ' + (selectedFirmaCihazForLogParser?.ad || '')"
    [width]="'900px'"
    [height]="'80vh'"
    (save)="saveLogParserConfiguration()"
    (visibleChange)="!logParserModalVisible && closeLogParserModal()">
    
    <div class="log-parser-content">
      <!-- Üst Başlık ve Kılavuz Butonu -->
      <div class="modal-header-actions">
        <button 
          pButton 
          type="button" 
          [label]="showLogParserHelp ? 'Kılavuzu Gizle' : 'Nasıl Kullanılır?'" 
          [icon]="showLogParserHelp ? 'pi pi-eye-slash' : 'pi pi-question-circle'"
          (click)="toggleLogParserHelp()"
          class="p-button-sm p-button-help">
        </button>
      </div>

      <!-- Kullanım Kılavuzu -->
      <div *ngIf="showLogParserHelp" class="usage-guide">
        <p-panel header="📖 Log Parser Kullanım Kılavuzu" styleClass="mb-3 help-panel">
          <div class="help-content">
            <h4>🎯 Amaç</h4>
            <p>Bu araç, cihazlardan gelen log verilerinin nasıl parse edileceğini tanımlamanızı sağlar. 
               Böylece ham log verisi anlamlı bilgilere dönüştürülür.</p>
            
            <h4>📋 Adım Adım Kullanım</h4>
            <ol>              <li><strong>Temel Ayarlar:</strong>
                <ul>
                  <li><strong>Delimiter:</strong> Log satırındaki verileri ayıran karakteri seçin (virgül, noktalı virgül, vs.)</li>
                  <li><strong>Tarih Formatı:</strong> Cihazın kullandığı tarih formatını dropdown'dan seçin. Örnek görüntüler ile kolay seçim yapabilirsiniz</li>
                  <li><strong>Saat Formatı:</strong> Cihazın kullandığı saat formatını dropdown'dan seçin. 24 saat veya 12 saat formatları mevcut</li>
                  <li><strong>Akıllı Örnek Yükle:</strong> Seçtiğiniz delimiter'a göre örnek log verisi oluşturur ve alan eşlemelerini otomatik tanımlar</li>
                </ul>
              </li>
              <li><strong>Alan Eşlemeleri:</strong>
                <ul>
                  <li>Log satırındaki her veri parçasının ne anlama geldiğini tanımlayın</li>
                  <li><strong>Pozisyon:</strong> Verinin log satırında kaçıncı sırada olduğunu belirtin (0'dan başlar)</li>
                  <li><strong>Alan Adı:</strong> Bu veriye hangi ismi vermek istediğinizi seçin</li>
                  <li><strong>Tip:</strong> Verinin türünü belirtin (sayı, metin, tarih, vs.)</li>
                </ul>
              </li>              <li><strong>Test:</strong>
                <ul>
                  <li>Örnek log satırını yapıştırın</li>
                  <li>"Test Et" butonuna basarak ayarlarınızı doğrulayın</li>
                  <li>Parse edilmiş sonucu kontrol edin</li>
                  <li><strong>Test başarılıysa:</strong> Veriler doğru şekilde ayrıştırıldı, kaydetme işlemine geçebilirsiniz</li>
                  <li><strong>Test başarısızsa:</strong> Ayarlarınızı kontrol edip tekrar deneyin</li>
                </ul>
              </li>
              <li><strong>JSON Konfigürasyon:</strong>
                <ul>
                  <li>Bu sekme, girdiğiniz tüm ayarların <strong>otomatik olarak JSON formatına</strong> dönüştürüldüğü halini gösterir</li>
                  <li>Bu JSON, sistem tarafından cihazdan gelen logları parse etmek için kullanılır</li>
                  <li><strong>Sadece görüntüleme amaçlıdır</strong> - bu alanı manuel olarak düzenlemenize gerek yoktur</li>
                  <li>Teknik ekiplerin konfigürasyonu kontrol etmesi için faydalıdır</li>
                </ul>
              </li>
              <li><strong>Kaydet:</strong> Ayarlar doğruysa "Kaydet" butonuna basın</li>
            </ol>
            
            <h4>💡 Örnek</h4>            <div class="example-box">
              <strong>Örnek Log Satırı:</strong><br>
              <code>1234,10:30,060125,1,001</code><br><br>
              
              <strong>Delimiter:</strong> Virgül (,)<br>
              <strong>Tarih Formatı:</strong> ddMMyy (060125 = 06.01.2025)<br>
              <strong>Saat Formatı:</strong> HH:mm (10:30)<br><br>
              
              <strong>Alan Eşlemeleri:</strong><br>
              • Pozisyon 0: Kullanıcı ID (1234)<br>
              • Pozisyon 1: Saat (10:30)<br>
              • Pozisyon 2: Tarih (060125)<br>
              • Pozisyon 3: Hareket Tipi (1=Giriş)<br>
              • Pozisyon 4: Cihaz ID (001)<br><br>
                <strong>Test Sonucu:</strong><br>
              <code>
              {{ '{' }}<br>
              &nbsp;&nbsp;"userId": "1234",<br>
              &nbsp;&nbsp;"time": "10:30",<br>
              &nbsp;&nbsp;"date": "060125",<br>
              &nbsp;&nbsp;"actionType": "1",<br>
              &nbsp;&nbsp;"deviceId": "001"<br>
              {{ '}' }}
              </code>
            </div>
          </div>
        </p-panel>
      </div>
      <!-- Cihaz Bilgisi -->
      <p-panel header="Cihaz Bilgileri" styleClass="mb-3">
        <div class="device-info">
          <p><strong>Firma:</strong> {{selectedFirmaCihazForLogParser?.firmaDto?.ad}}</p>
          <p><strong>Cihaz Adı:</strong> {{selectedFirmaCihazForLogParser?.ad}}</p>
          <p><strong>Cihaz Tipi:</strong> {{selectedFirmaCihazForLogParser?.firmaCihazTipKodDto?.kisaAd}}</p>
          <p><strong>Cihaz ID:</strong> {{selectedFirmaCihazForLogParser?.cihazMakineGercekId}}</p>
        </div>
      </p-panel>      <!-- Konfigürasyon Formu -->
      <p-accordion>
        <!-- Template Seçici -->
        <p-accordionTab header="🎯 Hazır Şablonlar" [selected]="false">
          <div class="template-selector">
            <div class="template-info">
              <p>Cihazınız için önceden hazırlanmış şablonlardan birini seçerek hızlıca başlayabilirsiniz.</p>
              
              <!-- Önerilen Şablonlar -->
              <div *ngIf="getRecommendedTemplates().length > 0" class="recommended-templates">
                <h4>📍 {{selectedFirmaCihazForLogParser?.firmaCihazTipKodDto?.kisaAd}} Cihazlar İçin Önerilen Şablonlar</h4>
                <div class="template-grid">
                  <div 
                    *ngFor="let template of getRecommendedTemplates()" 
                    class="template-card recommended"
                    [class.selected]="selectedTemplate?.templateName === template.templateName"
                    (click)="selectTemplate(template)">
                    <div class="template-header">
                      <h5>{{template.templateName}}</h5>
                      <span class="device-badge">{{template.deviceBrand}}</span>
                    </div>
                    <p class="template-description">{{template.description}}</p>
                    <div class="template-details">
                      <small>
                        <strong>Delimiter:</strong> {{template.logDelimiter}} | 
                        <strong>Tarih:</strong> {{template.logDateFormat}} | 
                        <strong>Saat:</strong> {{template.logTimeFormat}}
                      </small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Tüm Şablonlar -->
              <div class="all-templates">
                <h4>📚 Tüm Şablonlar</h4>
                <div class="template-filter-tabs">
                  <button 
                    type="button"
                    pButton
                    class="p-button-sm"
                    [class.p-button-outlined]="templateFilter !== 'ALL'"
                    (click)="templateFilter = 'ALL'">
                    Tümü
                  </button>
                  <button 
                    type="button"
                    pButton
                    class="p-button-sm"
                    [class.p-button-outlined]="templateFilter !== 'PDKS'"
                    (click)="templateFilter = 'PDKS'">
                    PDKS
                  </button>
                  <button 
                    type="button"
                    pButton
                    class="p-button-sm"
                    [class.p-button-outlined]="templateFilter !== 'ALARM'"
                    (click)="templateFilter = 'ALARM'">
                    Alarm
                  </button>
                  <button 
                    type="button"
                    pButton
                    class="p-button-sm"
                    [class.p-button-outlined]="templateFilter !== 'KAMERA'"
                    (click)="templateFilter = 'KAMERA'">
                    Kamera
                  </button>
                </div>

                <div class="template-grid">
                  <div 
                    *ngFor="let template of getFilteredTemplates()" 
                    class="template-card"
                    [class.selected]="selectedTemplate?.templateName === template.templateName"
                    (click)="selectTemplate(template)">
                    <div class="template-header">
                      <h5>{{template.templateName}}</h5>
                      <span class="device-badge" [class]="'badge-' + template.deviceType.toLowerCase()">
                        {{template.deviceType}}
                      </span>
                    </div>
                    <p class="template-description">{{template.description}}</p>
                    <div class="template-details">
                      <small>
                        <strong>Marka:</strong> {{template.deviceBrand}} | 
                        <strong>Delimiter:</strong> {{template.logDelimiter}} | 
                        <strong>Format:</strong> {{template.logDateFormat}}
                      </small>
                    </div>
                    <!-- Örnek Veri Önizlemesi -->
                    <div class="template-preview" *ngIf="template.sampleLogData">
                      <strong>Örnek:</strong>
                      <code>{{template.sampleLogData.split('\n')[0]}}</code>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Seçilen Şablon Bilgisi -->
              <div *ngIf="selectedTemplate" class="selected-template-info">
                <h4>✅ Seçilen Şablon: {{selectedTemplate.templateName}}</h4>
                <p>{{selectedTemplate.description}}</p>
                <button 
                  type="button"
                  pButton 
                  label="Şablonu Uygula"
                  icon="pi pi-check"
                  class="p-button-success p-button-sm"
                  (click)="applyTemplate(selectedTemplate)">
                </button>
                <button 
                  type="button"
                  pButton 
                  label="Seçimi Temizle"
                  icon="pi pi-times"
                  class="p-button-text p-button-sm"
                  (click)="selectedTemplate = null">
                </button>
              </div>
            </div>
          </div>
        </p-accordionTab>

        <!-- Temel Ayarlar -->
        <p-accordionTab header="Temel Parser Ayarları" [selected]="true">
          <div class="config-form">
            <div class="form-row">
              <div class="form-item">
                <label>Delimiter:</label>
                <p-dropdown 
                  [options]="delimiterOptions" 
                  [(ngModel)]="logParserConfig.delimiter"
                  optionLabel="label" 
                  optionValue="value"
                  placeholder="Delimiter seçin"
                  styleClass="w-full">
                </p-dropdown>
              </div>              <div class="form-item">
                <label>Tarih Formatı:</label>
                <p-dropdown 
                  [options]="dateFormatOptions" 
                  [(ngModel)]="logParserConfig.dateFormat"
                  [editable]="true"
                  optionLabel="label" 
                  optionValue="value"
                  placeholder="Tarih formatı seçin veya yazın"
                  styleClass="w-full">
                </p-dropdown>
              </div>
            </div>
            <div class="form-row">
              <div class="form-item">
                <label>Saat Formatı:</label>
                <p-dropdown 
                  [options]="timeFormatOptions" 
                  [(ngModel)]="logParserConfig.timeFormat"
                  [editable]="true"
                  optionLabel="label" 
                  optionValue="value"
                  placeholder="Saat formatı seçin veya yazın"
                  styleClass="w-full">
                </p-dropdown>
              </div>
              <div class="form-item">                <button 
                  pButton 
                  type="button" 
                  label="Akıllı Örnek Yükle" 
                  icon="pi pi-bolt"
                  (click)="loadLogParserSampleData()"
                  pTooltip="Örnek veri yükler ve alan eşlemelerini otomatik oluşturur"
                  class="p-button-secondary">
                </button>
              </div>
            </div>
          </div>
        </p-accordionTab>

        <!-- Alan Eşlemeleri -->
        <p-accordionTab header="Alan Eşlemeleri">
          <div class="field-mappings">
            <div class="field-mapping-header">
              <button 
                pButton 
                type="button" 
                label="Yeni Alan Ekle" 
                icon="pi pi-plus"
                (click)="addLogParserFieldMapping()"
                class="p-button-sm p-button-success">
              </button>
            </div>
            
            <div *ngFor="let field of logParserConfig.fieldMapping; let i = index" class="field-mapping-row">
              <div class="field-mapping-item">
                <label>Alan Adı:</label>
                <p-dropdown 
                  [options]="predefinedFields" 
                  [(ngModel)]="field.name"
                  [editable]="true"
                  optionLabel="label" 
                  optionValue="value"
                  placeholder="Alan adı seçin veya yazın"
                  styleClass="w-full">
                </p-dropdown>
              </div>
              <div class="field-mapping-item">
                <label>Pozisyon:</label>
                <input 
                  pInputText 
                  type="number" 
                  [(ngModel)]="field.index" 
                  class="w-full">
              </div>
              <div class="field-mapping-item">
                <label>Tip:</label>
                <p-dropdown 
                  [options]="fieldTypes" 
                  [(ngModel)]="field.type"
                  optionLabel="label" 
                  optionValue="value"
                  styleClass="w-full">
                </p-dropdown>
              </div>
              <div class="field-mapping-item">
                <label>Format:</label>
                <input 
                  pInputText 
                  [(ngModel)]="field.format" 
                  placeholder="Opsiyonel format"
                  class="w-full">
              </div>
              <div class="field-mapping-actions">
                <button 
                  pButton 
                  type="button" 
                  icon="pi pi-trash" 
                  (click)="removeLogParserFieldMapping(i)"
                  class="p-button-sm p-button-danger">
                </button>
              </div>
            </div>
          </div>
        </p-accordionTab>

        <!-- Test -->
        <p-accordionTab header="Test">
          <div class="test-section">
            <div class="form-item">
              <label>Örnek Log Verisi:</label>
              <textarea 
                pInputTextarea 
                [(ngModel)]="sampleLogData"
                rows="3"
                placeholder="Örnek log satırını buraya yapıştırın"
                class="w-full">
              </textarea>
            </div>
            
            <div class="test-actions">
              <button 
                pButton 
                type="button" 
                label="Test Et" 
                icon="pi pi-play"
                (click)="testLogParserConfiguration()"
                [loading]="isLogParserTesting"
                class="p-button-info">
              </button>
            </div>
            
            <!-- Test Sonucu -->
            <div *ngIf="testResult" class="test-result">
              <p-divider></p-divider>
              <h4>Test Sonucu</h4>
              <div class="result-status" [ngClass]="{'success': testResult.success, 'error': !testResult.success}">
                <i [class]="testResult.success ? 'pi pi-check' : 'pi pi-times'"></i>
                {{testResult.message}}
              </div>
              
              <div *ngIf="testResult.success && testResult.parsedData" class="parsed-data">
                <label>Parse Edilmiş Veri:</label>
                <pre>{{testResult.parsedData | json}}</pre>
              </div>
            </div>
          </div>
        </p-accordionTab>

        <!-- JSON Konfigürasyon -->
        <p-accordionTab header="JSON Konfigürasyon">
          <div class="json-config">
            <label>Konfigürasyon JSON:</label>
            <textarea 
              pInputTextarea 
              [value]="getLogParserConfigAsJson()"
              rows="15"
              readonly
              class="w-full json-textarea">
            </textarea>
          </div>
        </p-accordionTab>
      </p-accordion>
    </div>
  </app-modal>

    <!-- Silme Onay Dialogu -->
  <app-confirm-dialog
    (confirmed)="deleteFirmaCihaz()">
  </app-confirm-dialog>
</div>
