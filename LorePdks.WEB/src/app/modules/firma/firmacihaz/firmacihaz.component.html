<div class="firmacihaz-container">  <div class="firmacihaz-header">
    <h1>Firma Cihaz YÃ¶netimi</h1>
    <div class="firmacihaz-actions">      <div class="firma-filter">
        <app-select
          title="Firma"
          [itemListDto$]="firmaListDto$"
          [selectedValue]="selectedFirma?.eid"
          placeholder="Firmaya GÃ¶re Filtrele"
          (selectionChange)="onFirmaChange($event)">
        </app-select>
      </div>
      
      <app-button
        name="Yeni Cihaz"
        icon="pi pi-plus"
        class="p-button-sm"
        (onClick)="openAddFirmaCihazModal()">
      </app-button>
    </div>
  </div>
  
  <div class="firmacihaz-content" style="width: 100%;">
    <app-data-grid
      [data]="firmaCihazList"
      [columns]="columns"
      [loading]="loading"
      headerTitle="Firma Cihaz Listesi"
      [responsive]="true"
      [tableStyle]="{'width': '100%', 'min-width': '800px'}"
      [actionButtons]="actionButtons"
      (rowAction)="onRowAction($event)">
    </app-data-grid>
  </div>
  
  <!-- Firma Cihaz Ekleme/DÃ¼zenleme ModalÄ± -->
  <app-modal
    [(visible)]="firmaCihazModalVisible"
    [title]="firmaCihazModel.eid ? 'Cihaz DÃ¼zenle' : 'Yeni Cihaz'"
    [width]="'500px'"
    (save)="saveFirmaCihaz()"
    (visibleChange)="!firmaCihazModalVisible && onFirmaCihazModalClosed()">    <div class="firmacihaz-form">
      <div class="form-group">
        <app-select
          title="Firma"
          [itemListDto$]="firmaListDto$"
          [selectedValue]="firmaCihazModel.firmaDto?.eid"
          placeholder="Firma seÃ§iniz"
          [isRequired]="true"
          (selectionChange)="onModalFirmaChange($event)">
        </app-select>
      </div>      <div class="form-group">
        <app-select
          title="Cihaz Tipi"
          [itemListDto$]="cihazTipleriListDto$"
          [selectedValue]="firmaCihazModel.firmaCihazTipKodDto?.id"
          placeholder="Cihaz tipi seÃ§iniz"
          [isRequired]="true"
          [class]="'z-3'"
          (selectionChange)="onModalCihazTipChange($event)">
        </app-select>
        <!-- Debug bilgisi - cihaz tiplerini kontrol iÃ§in -->
        <small *ngIf="false" class="text-muted">
          SeÃ§ilen ID: {{firmaCihazModel.firmaCihazTipKodDto?.id}}
        </small>
      </div>
        <app-text-input
        title="Cihaz AdÄ±"
        [value]="firmaCihazModel.ad || ''"
        (valueChange)="firmaCihazModel.ad = $event"
        placeholder="Cihaz adÄ±nÄ± giriniz"
        [isRequired]="true">
      </app-text-input>      <app-text-input
        title="Cihaz ID"
        type="number"
        [value]="firmaCihazModel.cihazMakineGercekId != null ? firmaCihazModel.cihazMakineGercekId.toString() : ''"
        (valueChange)="firmaCihazModel.cihazMakineGercekId = parseFloat($event)"
        placeholder="Cihaz ID'sini giriniz"
        [isRequired]="true">
      </app-text-input>
        <app-text-input
        title="AÃ§Ä±klama"
        [value]="firmaCihazModel.aciklama || ''"
        (valueChange)="firmaCihazModel.aciklama = $event"
        placeholder="AÃ§Ä±klama giriniz">
      </app-text-input>    </div>
  </app-modal>
  <!-- Log Parser AyarlarÄ± ModalÄ± -->
  <app-modal
    [(visible)]="logParserModalVisible"
    [title]="'Log Parser AyarlarÄ± - ' + (selectedFirmaCihazForLogParser?.ad || '')"
    [width]="'900px'"
    [height]="'80vh'"
    (save)="saveLogParserConfiguration()"
    (visibleChange)="!logParserModalVisible && closeLogParserModal()">
    
    <div class="log-parser-content">
      <!-- Ãœst BaÅŸlÄ±k ve KÄ±lavuz Butonu -->
      <div class="modal-header-actions">
        <button 
          pButton 
          type="button" 
          [label]="showLogParserHelp ? 'KÄ±lavuzu Gizle' : 'NasÄ±l KullanÄ±lÄ±r?'" 
          [icon]="showLogParserHelp ? 'pi pi-eye-slash' : 'pi pi-question-circle'"
          (click)="toggleLogParserHelp()"
          class="p-button-sm p-button-help">
        </button>
      </div>

      <!-- KullanÄ±m KÄ±lavuzu -->
      <div *ngIf="showLogParserHelp" class="usage-guide">
        <p-panel header="ğŸ“– Log Parser KullanÄ±m KÄ±lavuzu" styleClass="mb-3 help-panel">
          <div class="help-content">
            <h4>ğŸ¯ AmaÃ§</h4>
            <p>Bu araÃ§, cihazlardan gelen log verilerinin nasÄ±l parse edileceÄŸini tanÄ±mlamanÄ±zÄ± saÄŸlar. 
               BÃ¶ylece ham log verisi anlamlÄ± bilgilere dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lÃ¼r.</p>
            
            <h4>ğŸ“‹ AdÄ±m AdÄ±m KullanÄ±m</h4>
            <ol>              <li><strong>Temel Ayarlar:</strong>
                <ul>
                  <li><strong>Delimiter:</strong> Log satÄ±rÄ±ndaki verileri ayÄ±ran karakteri seÃ§in (virgÃ¼l, noktalÄ± virgÃ¼l, vs.)</li>
                  <li><strong>Tarih FormatÄ±:</strong> CihazÄ±n kullandÄ±ÄŸÄ± tarih formatÄ±nÄ± dropdown'dan seÃ§in. Ã–rnek gÃ¶rÃ¼ntÃ¼ler ile kolay seÃ§im yapabilirsiniz</li>
                  <li><strong>Saat FormatÄ±:</strong> CihazÄ±n kullandÄ±ÄŸÄ± saat formatÄ±nÄ± dropdown'dan seÃ§in. 24 saat veya 12 saat formatlarÄ± mevcut</li>
                  <li><strong>AkÄ±llÄ± Ã–rnek YÃ¼kle:</strong> SeÃ§tiÄŸiniz delimiter'a gÃ¶re Ã¶rnek log verisi oluÅŸturur ve alan eÅŸlemelerini otomatik tanÄ±mlar</li>
                </ul>
              </li>
              <li><strong>Alan EÅŸlemeleri:</strong>
                <ul>
                  <li>Log satÄ±rÄ±ndaki her veri parÃ§asÄ±nÄ±n ne anlama geldiÄŸini tanÄ±mlayÄ±n</li>
                  <li><strong>Pozisyon:</strong> Verinin log satÄ±rÄ±nda kaÃ§Ä±ncÄ± sÄ±rada olduÄŸunu belirtin (0'dan baÅŸlar)</li>
                  <li><strong>Alan AdÄ±:</strong> Bu veriye hangi ismi vermek istediÄŸinizi seÃ§in</li>
                  <li><strong>Tip:</strong> Verinin tÃ¼rÃ¼nÃ¼ belirtin (sayÄ±, metin, tarih, vs.)</li>
                </ul>
              </li>              <li><strong>Test:</strong>
                <ul>
                  <li>Ã–rnek log satÄ±rÄ±nÄ± yapÄ±ÅŸtÄ±rÄ±n</li>
                  <li>"Test Et" butonuna basarak ayarlarÄ±nÄ±zÄ± doÄŸrulayÄ±n</li>
                  <li>Parse edilmiÅŸ sonucu kontrol edin</li>
                  <li><strong>Test baÅŸarÄ±lÄ±ysa:</strong> Veriler doÄŸru ÅŸekilde ayrÄ±ÅŸtÄ±rÄ±ldÄ±, kaydetme iÅŸlemine geÃ§ebilirsiniz</li>
                  <li><strong>Test baÅŸarÄ±sÄ±zsa:</strong> AyarlarÄ±nÄ±zÄ± kontrol edip tekrar deneyin</li>
                </ul>
              </li>
              <li><strong>JSON KonfigÃ¼rasyon:</strong>
                <ul>
                  <li>Bu sekme, girdiÄŸiniz tÃ¼m ayarlarÄ±n <strong>otomatik olarak JSON formatÄ±na</strong> dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼ÄŸÃ¼ halini gÃ¶sterir</li>
                  <li>Bu JSON, sistem tarafÄ±ndan cihazdan gelen loglarÄ± parse etmek iÃ§in kullanÄ±lÄ±r</li>
                  <li><strong>Sadece gÃ¶rÃ¼ntÃ¼leme amaÃ§lÄ±dÄ±r</strong> - bu alanÄ± manuel olarak dÃ¼zenlemenize gerek yoktur</li>
                  <li>Teknik ekiplerin konfigÃ¼rasyonu kontrol etmesi iÃ§in faydalÄ±dÄ±r</li>
                </ul>
              </li>
              <li><strong>Kaydet:</strong> Ayarlar doÄŸruysa "Kaydet" butonuna basÄ±n</li>
            </ol>
            
            <h4>ğŸ’¡ Ã–rnek</h4>            <div class="example-box">
              <strong>Ã–rnek Log SatÄ±rÄ±:</strong><br>
              <code>1234,10:30,060125,1,001</code><br><br>
              
              <strong>Delimiter:</strong> VirgÃ¼l (,)<br>
              <strong>Tarih FormatÄ±:</strong> ddMMyy (060125 = 06.01.2025)<br>
              <strong>Saat FormatÄ±:</strong> HH:mm (10:30)<br><br>
              
              <strong>Alan EÅŸlemeleri:</strong><br>
              â€¢ Pozisyon 0: KullanÄ±cÄ± ID (1234)<br>
              â€¢ Pozisyon 1: Saat (10:30)<br>
              â€¢ Pozisyon 2: Tarih (060125)<br>
              â€¢ Pozisyon 3: Hareket Tipi (1=GiriÅŸ)<br>
              â€¢ Pozisyon 4: Cihaz ID (001)<br><br>
                <strong>Test Sonucu:</strong><br>
              <code>
              {{ '{' }}<br>
              &nbsp;&nbsp;"userId": "1234",<br>
              &nbsp;&nbsp;"time": "10:30",<br>
              &nbsp;&nbsp;"date": "060125",<br>
              &nbsp;&nbsp;"actionType": "1",<br>
              &nbsp;&nbsp;"deviceId": "001"<br>
              {{ '}' }}
              </code>
            </div>
          </div>
        </p-panel>
      </div>
      <!-- Cihaz Bilgisi -->
      <p-panel header="Cihaz Bilgileri" styleClass="mb-3">
        <div class="device-info">
          <p><strong>Firma:</strong> {{selectedFirmaCihazForLogParser?.firmaDto?.ad}}</p>
          <p><strong>Cihaz AdÄ±:</strong> {{selectedFirmaCihazForLogParser?.ad}}</p>
          <p><strong>Cihaz Tipi:</strong> {{selectedFirmaCihazForLogParser?.firmaCihazTipKodDto?.kisaAd}}</p>
          <p><strong>Cihaz ID:</strong> {{selectedFirmaCihazForLogParser?.cihazMakineGercekId}}</p>
        </div>
      </p-panel>      <!-- KonfigÃ¼rasyon Formu -->
      <p-accordion>
        <!-- Template SeÃ§ici -->
        <p-accordionTab header="ğŸ¯ HazÄ±r Åablonlar" [selected]="false">
          <div class="template-selector">
            <div class="template-info">
              <p>CihazÄ±nÄ±z iÃ§in Ã¶nceden hazÄ±rlanmÄ±ÅŸ ÅŸablonlardan birini seÃ§erek hÄ±zlÄ±ca baÅŸlayabilirsiniz.</p>
              
              <!-- Ã–nerilen Åablonlar -->
              <div *ngIf="getRecommendedTemplates().length > 0" class="recommended-templates">
                <h4>ğŸ“ {{selectedFirmaCihazForLogParser?.firmaCihazTipKodDto?.kisaAd}} Cihazlar Ä°Ã§in Ã–nerilen Åablonlar</h4>
                <div class="template-grid">
                  <div 
                    *ngFor="let template of getRecommendedTemplates()" 
                    class="template-card recommended"
                    [class.selected]="selectedTemplate?.templateName === template.templateName"
                    (click)="selectTemplate(template)">
                    <div class="template-header">
                      <h5>{{template.templateName}}</h5>
                      <span class="device-badge">{{template.deviceBrand}}</span>
                    </div>
                    <p class="template-description">{{template.description}}</p>
                    <div class="template-details">
                      <small>
                        <strong>Delimiter:</strong> {{template.logDelimiter}} | 
                        <strong>Tarih:</strong> {{template.logDateFormat}} | 
                        <strong>Saat:</strong> {{template.logTimeFormat}}
                      </small>
                    </div>
                  </div>
                </div>
              </div>

              <!-- TÃ¼m Åablonlar -->
              <div class="all-templates">
                <h4>ğŸ“š TÃ¼m Åablonlar</h4>
                <div class="template-filter-tabs">
                  <button 
                    type="button"
                    pButton
                    class="p-button-sm"
                    [class.p-button-outlined]="templateFilter !== 'ALL'"
                    (click)="templateFilter = 'ALL'">
                    TÃ¼mÃ¼
                  </button>
                  <button 
                    type="button"
                    pButton
                    class="p-button-sm"
                    [class.p-button-outlined]="templateFilter !== 'PDKS'"
                    (click)="templateFilter = 'PDKS'">
                    PDKS
                  </button>
                  <button 
                    type="button"
                    pButton
                    class="p-button-sm"
                    [class.p-button-outlined]="templateFilter !== 'ALARM'"
                    (click)="templateFilter = 'ALARM'">
                    Alarm
                  </button>
                  <button 
                    type="button"
                    pButton
                    class="p-button-sm"
                    [class.p-button-outlined]="templateFilter !== 'KAMERA'"
                    (click)="templateFilter = 'KAMERA'">
                    Kamera
                  </button>
                </div>

                <div class="template-grid">
                  <div 
                    *ngFor="let template of getFilteredTemplates()" 
                    class="template-card"
                    [class.selected]="selectedTemplate?.templateName === template.templateName"
                    (click)="selectTemplate(template)">
                    <div class="template-header">
                      <h5>{{template.templateName}}</h5>
                      <span class="device-badge" [class]="'badge-' + template.deviceType.toLowerCase()">
                        {{template.deviceType}}
                      </span>
                    </div>
                    <p class="template-description">{{template.description}}</p>
                    <div class="template-details">
                      <small>
                        <strong>Marka:</strong> {{template.deviceBrand}} | 
                        <strong>Delimiter:</strong> {{template.logDelimiter}} | 
                        <strong>Format:</strong> {{template.logDateFormat}}
                      </small>
                    </div>
                    <!-- Ã–rnek Veri Ã–nizlemesi -->
                    <div class="template-preview" *ngIf="template.sampleLogData">
                      <strong>Ã–rnek:</strong>
                      <code>{{template.sampleLogData.split('\n')[0]}}</code>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- SeÃ§ilen Åablon Bilgisi -->
              <div *ngIf="selectedTemplate" class="selected-template-info">
                <h4>âœ… SeÃ§ilen Åablon: {{selectedTemplate.templateName}}</h4>
                <p>{{selectedTemplate.description}}</p>
                <button 
                  type="button"
                  pButton 
                  label="Åablonu Uygula"
                  icon="pi pi-check"
                  class="p-button-success p-button-sm"
                  (click)="applyTemplate(selectedTemplate)">
                </button>
                <button 
                  type="button"
                  pButton 
                  label="SeÃ§imi Temizle"
                  icon="pi pi-times"
                  class="p-button-text p-button-sm"
                  (click)="selectedTemplate = null">
                </button>
              </div>
            </div>
          </div>
        </p-accordionTab>

        <!-- Temel Ayarlar -->
        <p-accordionTab header="Temel Parser AyarlarÄ±" [selected]="true">
          <div class="config-form">
            <div class="form-row">
              <div class="form-item">
                <label>Delimiter:</label>
                <p-dropdown 
                  [options]="delimiterOptions" 
                  [(ngModel)]="logParserConfig.delimiter"
                  optionLabel="label" 
                  optionValue="value"
                  placeholder="Delimiter seÃ§in"
                  styleClass="w-full">
                </p-dropdown>
              </div>              <div class="form-item">
                <label>Tarih FormatÄ±:</label>
                <p-dropdown 
                  [options]="dateFormatOptions" 
                  [(ngModel)]="logParserConfig.dateFormat"
                  [editable]="true"
                  optionLabel="label" 
                  optionValue="value"
                  placeholder="Tarih formatÄ± seÃ§in veya yazÄ±n"
                  styleClass="w-full">
                </p-dropdown>
              </div>
            </div>
            <div class="form-row">
              <div class="form-item">
                <label>Saat FormatÄ±:</label>
                <p-dropdown 
                  [options]="timeFormatOptions" 
                  [(ngModel)]="logParserConfig.timeFormat"
                  [editable]="true"
                  optionLabel="label" 
                  optionValue="value"
                  placeholder="Saat formatÄ± seÃ§in veya yazÄ±n"
                  styleClass="w-full">
                </p-dropdown>
              </div>
              <div class="form-item">                <button 
                  pButton 
                  type="button" 
                  label="AkÄ±llÄ± Ã–rnek YÃ¼kle" 
                  icon="pi pi-bolt"
                  (click)="loadLogParserSampleData()"
                  pTooltip="Ã–rnek veri yÃ¼kler ve alan eÅŸlemelerini otomatik oluÅŸturur"
                  class="p-button-secondary">
                </button>
              </div>
            </div>
          </div>
        </p-accordionTab>

        <!-- Alan EÅŸlemeleri -->
        <p-accordionTab header="Alan EÅŸlemeleri">
          <div class="field-mappings">
            <div class="field-mapping-header">
              <button 
                pButton 
                type="button" 
                label="Yeni Alan Ekle" 
                icon="pi pi-plus"
                (click)="addLogParserFieldMapping()"
                class="p-button-sm p-button-success">
              </button>
            </div>
            
            <div *ngFor="let field of logParserConfig.fieldMapping; let i = index" class="field-mapping-row">
              <div class="field-mapping-item">
                <label>Alan AdÄ±:</label>
                <p-dropdown 
                  [options]="predefinedFields" 
                  [(ngModel)]="field.name"
                  [editable]="true"
                  optionLabel="label" 
                  optionValue="value"
                  placeholder="Alan adÄ± seÃ§in veya yazÄ±n"
                  styleClass="w-full">
                </p-dropdown>
              </div>
              <div class="field-mapping-item">
                <label>Pozisyon:</label>
                <input 
                  pInputText 
                  type="number" 
                  [(ngModel)]="field.index" 
                  class="w-full">
              </div>
              <div class="field-mapping-item">
                <label>Tip:</label>
                <p-dropdown 
                  [options]="fieldTypes" 
                  [(ngModel)]="field.type"
                  optionLabel="label" 
                  optionValue="value"
                  styleClass="w-full">
                </p-dropdown>
              </div>
              <div class="field-mapping-item">
                <label>Format:</label>
                <input 
                  pInputText 
                  [(ngModel)]="field.format" 
                  placeholder="Opsiyonel format"
                  class="w-full">
              </div>
              <div class="field-mapping-actions">
                <button 
                  pButton 
                  type="button" 
                  icon="pi pi-trash" 
                  (click)="removeLogParserFieldMapping(i)"
                  class="p-button-sm p-button-danger">
                </button>
              </div>
            </div>
          </div>
        </p-accordionTab>

        <!-- Test -->
        <p-accordionTab header="Test">
          <div class="test-section">
            <div class="form-item">
              <label>Ã–rnek Log Verisi:</label>
              <textarea 
                pInputTextarea 
                [(ngModel)]="sampleLogData"
                rows="3"
                placeholder="Ã–rnek log satÄ±rÄ±nÄ± buraya yapÄ±ÅŸtÄ±rÄ±n"
                class="w-full">
              </textarea>
            </div>
            
            <div class="test-actions">
              <button 
                pButton 
                type="button" 
                label="Test Et" 
                icon="pi pi-play"
                (click)="testLogParserConfiguration()"
                [loading]="isLogParserTesting"
                class="p-button-info">
              </button>
            </div>
            
            <!-- Test Sonucu -->
            <div *ngIf="testResult" class="test-result">
              <p-divider></p-divider>
              <h4>Test Sonucu</h4>
              <div class="result-status" [ngClass]="{'success': testResult.success, 'error': !testResult.success}">
                <i [class]="testResult.success ? 'pi pi-check' : 'pi pi-times'"></i>
                {{testResult.message}}
              </div>
              
              <div *ngIf="testResult.success && testResult.parsedData" class="parsed-data">
                <label>Parse EdilmiÅŸ Veri:</label>
                <pre>{{testResult.parsedData | json}}</pre>
              </div>
            </div>
          </div>
        </p-accordionTab>

        <!-- JSON KonfigÃ¼rasyon -->
        <p-accordionTab header="JSON KonfigÃ¼rasyon">
          <div class="json-config">
            <label>KonfigÃ¼rasyon JSON:</label>
            <textarea 
              pInputTextarea 
              [value]="getLogParserConfigAsJson()"
              rows="15"
              readonly
              class="w-full json-textarea">
            </textarea>
          </div>
        </p-accordionTab>
      </p-accordion>
    </div>
  </app-modal>

    <!-- Silme Onay Dialogu -->
  <app-confirm-dialog
    (confirmed)="deleteFirmaCihaz()">
  </app-confirm-dialog>
</div>
