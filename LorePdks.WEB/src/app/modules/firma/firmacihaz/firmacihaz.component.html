<div class="firmacihaz-container">  <div class="firmacihaz-header">
    <h1>Firma Cihaz YÃ¶netimi</h1>
    <div class="firmacihaz-actions">      <div class="firma-filter">
        <app-select
          title="Firma"
          [itemListDto$]="firmaListDto$"
          [selectedValue]="selectedFirma?.eid"
          placeholder="Firmaya GÃ¶re Filtrele"
          (selectionChange)="onFirmaChange($event)">
        </app-select>
      </div>
      
      <app-button
        name="Yeni Cihaz"
        icon="pi pi-plus"
        class="p-button-sm"
        (onClick)="openAddFirmaCihazModal()">
      </app-button>
    </div>
  </div>
  
  <div class="firmacihaz-content" style="width: 100%;">
    <app-data-grid
      [data]="firmaCihazList"
      [columns]="columns"
      [loading]="loading"
      headerTitle="Firma Cihaz Listesi"
      [responsive]="true"
      [tableStyle]="{'width': '100%', 'min-width': '800px'}"
      [actionButtons]="actionButtons"
      (rowAction)="onRowAction($event)">
    </app-data-grid>
  </div>
  
  <!-- Firma Cihaz Ekleme/DÃ¼zenleme ModalÄ± -->
  <app-modal
    [(visible)]="firmaCihazModalVisible"
    [title]="firmaCihazModel.eid ? 'Cihaz DÃ¼zenle' : 'Yeni Cihaz'"
    [width]="'500px'"
    (save)="saveFirmaCihaz()"
    (visibleChange)="!firmaCihazModalVisible && onFirmaCihazModalClosed()">    <div class="firmacihaz-form">
      <div class="form-group">
        <app-select
          title="Firma"
          [itemListDto$]="firmaListDto$"
          [selectedValue]="firmaCihazModel.firmaDto?.eid"
          placeholder="Firma seÃ§iniz"
          [isRequired]="true"
          (selectionChange)="onModalFirmaChange($event)">
        </app-select>
      </div>      <div class="form-group">
        <app-select
          title="Cihaz Tipi"
          [itemListDto$]="cihazTipleriListDto$"
          [selectedValue]="firmaCihazModel.firmaCihazTipKodDto?.id"
          placeholder="Cihaz tipi seÃ§iniz"
          [isRequired]="true"
          [class]="'z-3'"
          (selectionChange)="onModalCihazTipChange($event)">
        </app-select>
        <!-- Debug bilgisi - cihaz tiplerini kontrol iÃ§in -->
        <small *ngIf="false" class="text-muted">
          SeÃ§ilen ID: {{firmaCihazModel.firmaCihazTipKodDto?.id}}
        </small>
      </div>
        <app-text-input
        title="Cihaz AdÄ±"
        [value]="firmaCihazModel.ad || ''"
        (valueChange)="firmaCihazModel.ad = $event"
        placeholder="Cihaz adÄ±nÄ± giriniz"
        [isRequired]="true">
      </app-text-input>      <app-text-input
        title="Cihaz ID"
        type="number"
        [value]="firmaCihazModel.cihazMakineGercekId != null ? firmaCihazModel.cihazMakineGercekId.toString() : ''"
        (valueChange)="firmaCihazModel.cihazMakineGercekId = parseFloat($event)"
        placeholder="Cihaz ID'sini giriniz"
        [isRequired]="true">
      </app-text-input>
        <app-text-input
        title="AÃ§Ä±klama"
        [value]="firmaCihazModel.aciklama || ''"
        (valueChange)="firmaCihazModel.aciklama = $event"
        placeholder="AÃ§Ä±klama giriniz">
      </app-text-input>    </div>
  </app-modal>
  <!-- Log Parser AyarlarÄ± ModalÄ± -->
  <app-modal
    [(visible)]="logParserModalVisible"
    [title]="'Log Parser AyarlarÄ± - ' + (selectedFirmaCihazForLogParser?.ad || '')"
    [width]="'900px'"
    [height]="'80vh'"
    (save)="saveLogParserConfiguration()"
    (visibleChange)="!logParserModalVisible && closeLogParserModal()">
    
    <div class="log-parser-content">
      <!-- Ãœst BaÅŸlÄ±k ve KÄ±lavuz Butonu -->
      <div class="modal-header-actions">
        <button 
          pButton 
          type="button" 
          [label]="showLogParserHelp ? 'KÄ±lavuzu Gizle' : 'NasÄ±l KullanÄ±lÄ±r?'" 
          [icon]="showLogParserHelp ? 'pi pi-eye-slash' : 'pi pi-question-circle'"
          (click)="toggleLogParserHelp()"
          class="p-button-sm p-button-help">
        </button>
      </div>

      <!-- KullanÄ±m KÄ±lavuzu -->
      <div *ngIf="showLogParserHelp" class="usage-guide">
        <p-panel header="ğŸ“– Log Parser KullanÄ±m KÄ±lavuzu" styleClass="mb-3 help-panel">
          <div class="help-content">
            <h4>ğŸ¯ AmaÃ§</h4>
            <p>Bu araÃ§, cihazlardan gelen log verilerinin nasÄ±l parse edileceÄŸini tanÄ±mlamanÄ±zÄ± saÄŸlar. 
               BÃ¶ylece ham log verisi anlamlÄ± bilgilere dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lÃ¼r.</p>
            
            <h4>ğŸ“‹ AdÄ±m AdÄ±m KullanÄ±m</h4>
            <ol>
              <li><strong>Temel Ayarlar:</strong>
                <ul>
                  <li><strong>Delimiter:</strong> Log satÄ±rÄ±ndaki verileri ayÄ±ran karakteri seÃ§in (virgÃ¼l, noktalÄ± virgÃ¼l, vs.)</li>
                  <li><strong>Tarih/Saat FormatÄ±:</strong> CihazÄ±n kullandÄ±ÄŸÄ± tarih ve saat formatÄ±nÄ± belirtin</li>
                </ul>
              </li>
              <li><strong>Alan EÅŸlemeleri:</strong>
                <ul>
                  <li>Log satÄ±rÄ±ndaki her veri parÃ§asÄ±nÄ±n ne anlama geldiÄŸini tanÄ±mlayÄ±n</li>
                  <li><strong>Pozisyon:</strong> Verinin log satÄ±rÄ±nda kaÃ§Ä±ncÄ± sÄ±rada olduÄŸunu belirtin (0'dan baÅŸlar)</li>
                  <li><strong>Alan AdÄ±:</strong> Bu veriye hangi ismi vermek istediÄŸinizi seÃ§in</li>
                  <li><strong>Tip:</strong> Verinin tÃ¼rÃ¼nÃ¼ belirtin (sayÄ±, metin, tarih, vs.)</li>
                </ul>
              </li>
              <li><strong>Test:</strong>
                <ul>
                  <li>Ã–rnek log satÄ±rÄ±nÄ± yapÄ±ÅŸtÄ±rÄ±n</li>
                  <li>"Test Et" butonuna basarak ayarlarÄ±nÄ±zÄ± doÄŸrulayÄ±n</li>
                  <li>Parse edilmiÅŸ sonucu kontrol edin</li>
                </ul>
              </li>
              <li><strong>Kaydet:</strong> Ayarlar doÄŸruysa "Kaydet" butonuna basÄ±n</li>
            </ol>
            
            <h4>ğŸ’¡ Ã–rnek</h4>
            <div class="example-box">
              <strong>Ã–rnek Log SatÄ±rÄ±:</strong><br>
              <code>1234,10:30,060125,1,001</code><br><br>
              
              <strong>Alan EÅŸlemeleri:</strong><br>
              â€¢ Pozisyon 0: KullanÄ±cÄ± ID (1234)<br>
              â€¢ Pozisyon 1: Saat (10:30)<br>
              â€¢ Pozisyon 2: Tarih (060125)<br>
              â€¢ Pozisyon 3: Hareket Tipi (1=GiriÅŸ)<br>
              â€¢ Pozisyon 4: Cihaz ID (001)
            </div>
          </div>
        </p-panel>
      </div>
      <!-- Cihaz Bilgisi -->
      <p-panel header="Cihaz Bilgileri" styleClass="mb-3">
        <div class="device-info">
          <p><strong>Firma:</strong> {{selectedFirmaCihazForLogParser?.firmaDto?.ad}}</p>
          <p><strong>Cihaz AdÄ±:</strong> {{selectedFirmaCihazForLogParser?.ad}}</p>
          <p><strong>Cihaz Tipi:</strong> {{selectedFirmaCihazForLogParser?.firmaCihazTipKodDto?.kisaAd}}</p>
          <p><strong>Cihaz ID:</strong> {{selectedFirmaCihazForLogParser?.cihazMakineGercekId}}</p>
        </div>
      </p-panel>

      <!-- KonfigÃ¼rasyon Formu -->
      <p-accordion>
        <!-- Temel Ayarlar -->
        <p-accordionTab header="Temel Parser AyarlarÄ±" [selected]="true">
          <div class="config-form">
            <div class="form-row">
              <div class="form-item">
                <label>Delimiter:</label>
                <p-dropdown 
                  [options]="delimiterOptions" 
                  [(ngModel)]="logParserConfig.delimiter"
                  optionLabel="label" 
                  optionValue="value"
                  placeholder="Delimiter seÃ§in"
                  styleClass="w-full">
                </p-dropdown>
              </div>
              <div class="form-item">
                <label>Tarih FormatÄ±:</label>
                <input 
                  pInputText 
                  [(ngModel)]="logParserConfig.dateFormat" 
                  placeholder="dd.MM.yyyy HH:mm:ss"
                  class="w-full">
              </div>
            </div>
            <div class="form-row">
              <div class="form-item">
                <label>Saat FormatÄ±:</label>
                <input 
                  pInputText 
                  [(ngModel)]="logParserConfig.timeFormat" 
                  placeholder="HH:mm:ss"
                  class="w-full">
              </div>
              <div class="form-item">
                <button 
                  pButton 
                  type="button" 
                  label="Ã–rnek Veri YÃ¼kle" 
                  icon="pi pi-download"
                  (click)="loadLogParserSampleData()"
                  class="p-button-secondary">
                </button>
              </div>
            </div>
          </div>
        </p-accordionTab>

        <!-- Alan EÅŸlemeleri -->
        <p-accordionTab header="Alan EÅŸlemeleri">
          <div class="field-mappings">
            <div class="field-mapping-header">
              <button 
                pButton 
                type="button" 
                label="Yeni Alan Ekle" 
                icon="pi pi-plus"
                (click)="addLogParserFieldMapping()"
                class="p-button-sm p-button-success">
              </button>
            </div>
            
            <div *ngFor="let field of logParserConfig.fieldMapping; let i = index" class="field-mapping-row">
              <div class="field-mapping-item">
                <label>Alan AdÄ±:</label>
                <p-dropdown 
                  [options]="predefinedFields" 
                  [(ngModel)]="field.name"
                  [editable]="true"
                  optionLabel="label" 
                  optionValue="value"
                  placeholder="Alan adÄ± seÃ§in veya yazÄ±n"
                  styleClass="w-full">
                </p-dropdown>
              </div>
              <div class="field-mapping-item">
                <label>Pozisyon:</label>
                <input 
                  pInputText 
                  type="number" 
                  [(ngModel)]="field.index" 
                  class="w-full">
              </div>
              <div class="field-mapping-item">
                <label>Tip:</label>
                <p-dropdown 
                  [options]="fieldTypes" 
                  [(ngModel)]="field.type"
                  optionLabel="label" 
                  optionValue="value"
                  styleClass="w-full">
                </p-dropdown>
              </div>
              <div class="field-mapping-item">
                <label>Format:</label>
                <input 
                  pInputText 
                  [(ngModel)]="field.format" 
                  placeholder="Opsiyonel format"
                  class="w-full">
              </div>
              <div class="field-mapping-actions">
                <button 
                  pButton 
                  type="button" 
                  icon="pi pi-trash" 
                  (click)="removeLogParserFieldMapping(i)"
                  class="p-button-sm p-button-danger">
                </button>
              </div>
            </div>
          </div>
        </p-accordionTab>

        <!-- Test -->
        <p-accordionTab header="Test">
          <div class="test-section">
            <div class="form-item">
              <label>Ã–rnek Log Verisi:</label>
              <textarea 
                pInputTextarea 
                [(ngModel)]="sampleLogData"
                rows="3"
                placeholder="Ã–rnek log satÄ±rÄ±nÄ± buraya yapÄ±ÅŸtÄ±rÄ±n"
                class="w-full">
              </textarea>
            </div>
            
            <div class="test-actions">
              <button 
                pButton 
                type="button" 
                label="Test Et" 
                icon="pi pi-play"
                (click)="testLogParserConfiguration()"
                [loading]="isLogParserTesting"
                class="p-button-info">
              </button>
            </div>
            
            <!-- Test Sonucu -->
            <div *ngIf="testResult" class="test-result">
              <p-divider></p-divider>
              <h4>Test Sonucu</h4>
              <div class="result-status" [ngClass]="{'success': testResult.success, 'error': !testResult.success}">
                <i [class]="testResult.success ? 'pi pi-check' : 'pi pi-times'"></i>
                {{testResult.message}}
              </div>
              
              <div *ngIf="testResult.success && testResult.parsedData" class="parsed-data">
                <label>Parse EdilmiÅŸ Veri:</label>
                <pre>{{testResult.parsedData | json}}</pre>
              </div>
            </div>
          </div>
        </p-accordionTab>

        <!-- JSON KonfigÃ¼rasyon -->
        <p-accordionTab header="JSON KonfigÃ¼rasyon">
          <div class="json-config">
            <label>KonfigÃ¼rasyon JSON:</label>
            <textarea 
              pInputTextarea 
              [value]="getLogParserConfigAsJson()"
              rows="15"
              readonly
              class="w-full json-textarea">
            </textarea>
          </div>
        </p-accordionTab>
      </p-accordion>
    </div>
  </app-modal>

    <!-- Silme Onay Dialogu -->
  <app-confirm-dialog
    (confirmed)="deleteFirmaCihaz()">
  </app-confirm-dialog>
</div>
