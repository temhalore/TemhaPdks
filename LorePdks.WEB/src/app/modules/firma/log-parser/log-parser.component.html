<div class="log-parser-container">
  <!-- BaÅŸlÄ±k ve Geri Butonu -->
  <div class="page-header">
    <div class="page-title">
      <h2>Log Parser AyarlarÄ±</h2>
      <h4 *ngIf="firmaCihaz">{{ firmaCihaz.ad }} - {{ firmaCihaz.firmaCihazTipKodDto?.kisaAd }}</h4>
    </div>
    <div class="page-actions">
      <button 
        pButton 
        type="button" 
        [label]="showHelp ? 'KÄ±lavuzu Gizle' : 'NasÄ±l KullanÄ±lÄ±r?'" 
        [icon]="showHelp ? 'pi pi-eye-slash' : 'pi pi-question-circle'"
        (click)="toggleHelp()"
        class="p-button-help p-button-sm">
      </button>
      <button 
        pButton 
        type="button" 
        label="Geri DÃ¶n"
        icon="pi pi-arrow-left"
        (click)="goBack()"
        class="p-button-secondary p-button-sm">
      </button>
    </div>
  </div>

  <!-- YÃ¼kleniyor gÃ¶stergesi -->
  <div *ngIf="isLoading" class="loading-container">
    <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
    <p>YÃ¼kleniyor...</p>
  </div>

  <!-- Ana Ä°Ã§erik -->
  <div *ngIf="!isLoading" class="log-parser-content">
    <!-- KullanÄ±m KÄ±lavuzu -->
    <div *ngIf="showHelp" class="usage-guide">
      <p-panel header="ğŸ“– Log Parser KullanÄ±m KÄ±lavuzu" styleClass="mb-3 help-panel">
        <div class="help-content">
          <h4>ğŸ¯ AmaÃ§</h4>
          <p>Bu araÃ§, cihazlardan gelen log verilerinin nasÄ±l parse edileceÄŸini tanÄ±mlamanÄ±zÄ± saÄŸlar. 
             BÃ¶ylece ham log verisi anlamlÄ± bilgilere dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lÃ¼r.</p>
          
          <h4>ğŸ“‹ AdÄ±m AdÄ±m KullanÄ±m</h4>
          <ol>
            <li><strong>Temel Ayarlar:</strong>
              <ul>
                <li><strong>Delimiter:</strong> Log satÄ±rÄ±ndaki verileri ayÄ±ran karakteri seÃ§in</li>
                <li><strong>Tarih FormatÄ±:</strong> CihazÄ±n kullandÄ±ÄŸÄ± tarih formatÄ±nÄ± seÃ§in</li>
                <li><strong>Saat FormatÄ±:</strong> CihazÄ±n kullandÄ±ÄŸÄ± saat formatÄ±nÄ± seÃ§in</li>
              </ul>
            </li>
            <li><strong>Alan EÅŸlemeleri:</strong>
              <ul>
                <li>Log satÄ±rÄ±ndaki her veri parÃ§asÄ±nÄ±n ne anlama geldiÄŸini tanÄ±mlayÄ±n</li>
                <li><strong>Pozisyon:</strong> Verinin log satÄ±rÄ±nda kaÃ§Ä±ncÄ± sÄ±rada olduÄŸu (0'dan baÅŸlar)</li>
                <li><strong>Alan AdÄ±:</strong> Bu veriye hangi isim verilecek</li>
                <li><strong>Tip:</strong> Verinin tÃ¼rÃ¼ (sayÄ±, metin, tarih, vs.)</li>
              </ul>
            </li>
            <li><strong>Test:</strong>
              <ul>
                <li>Ã–rnek log satÄ±rÄ±nÄ± girin</li>
                <li>"Test Et" butonuna basÄ±n</li>
                <li>Parse edilmiÅŸ sonucu kontrol edin</li>
              </ul>
            </li>
          </ol>
          
          <h4>ğŸ’¡ Ã–rnek</h4>
          <div class="example-box">
            <strong>Ã–rnek Log SatÄ±rÄ±:</strong><br>
            <code>1234,10:30,060125,1,001</code><br><br>
            
            <strong>Delimiter:</strong> VirgÃ¼l (,)<br>
            <strong>Tarih FormatÄ±:</strong> ddMMyy (060125 = 06.01.2025)<br>
            <strong>Saat FormatÄ±:</strong> HH:mm (10:30)<br><br>
            
            <strong>Alan EÅŸlemeleri:</strong><br>
            â€¢ Pozisyon 0: KullanÄ±cÄ± ID (1234)<br>
            â€¢ Pozisyon 1: Saat (10:30)<br>
            â€¢ Pozisyon 2: Tarih (060125)<br>
            â€¢ Pozisyon 3: Hareket Tipi (1=GiriÅŸ)<br>
            â€¢ Pozisyon 4: Cihaz ID (001)<br>
          </div>
        </div>
      </p-panel>
    </div>

    <!-- Cihaz Bilgisi -->
    <p-panel header="Cihaz Bilgileri" styleClass="mb-3">
      <div class="device-info">
        <p><strong>Firma:</strong> {{firmaCihaz?.firmaDto?.ad}}</p>
        <p><strong>Cihaz AdÄ±:</strong> {{firmaCihaz?.ad}}</p>
        <p><strong>Cihaz Tipi:</strong> {{firmaCihaz?.firmaCihazTipKodDto?.kisaAd}}</p>
        <p><strong>Cihaz ID:</strong> {{firmaCihaz?.cihazMakineGercekId}}</p>
      </div>
    </p-panel>

    <!-- TabView ile BÃ¶lÃ¼mler -->
    <p-tabView [(activeIndex)]="activeTabIndex">
      <!-- Temel Ayarlar -->
      <p-tabPanel header="Temel Ayarlar">
        <div class="config-section">
          <div class="form-row">
            <div class="form-item">
              <label>Delimiter:</label>              <app-select
                title=""
                [itemListDto$]="delimiterOptions$"
                [(selectedValue)]="logParserConfig.delimiter"
                placeholder="Delimiter seÃ§in">
              </app-select>
            </div>
            <div class="form-item">
              <label>Tarih FormatÄ±:</label>              <app-select
                title=""
                [itemListDto$]="dateFormatOptions$"
                [(selectedValue)]="logParserConfig.dateFormat"
                placeholder="Tarih formatÄ± seÃ§in">
              </app-select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-item">
              <label>Saat FormatÄ±:</label>              <app-select
                title=""
                [itemListDto$]="timeFormatOptions$"
                [(selectedValue)]="logParserConfig.timeFormat"
                placeholder="Saat formatÄ± seÃ§in">              </app-select>
            </div>
          </div>
        </div>
      </p-tabPanel>

      <!-- Alan EÅŸlemeleri -->
      <p-tabPanel header="Alan EÅŸlemeleri">
        <div class="field-mappings">
          <div class="field-mapping-header">
            <button 
              pButton 
              type="button" 
              label="Yeni Alan Ekle" 
              icon="pi pi-plus"
              (click)="addFieldMapping()"
              class="p-button-sm p-button-success">
            </button>
          </div>
          
          <div *ngFor="let field of logParserConfig.fieldMapping; let i = index" class="field-mapping-row">
            <div class="field-mapping-item">
              <label>Alan AdÄ±:</label>
              <app-select                title=""
                [itemListDto$]="predefinedFields$"
                [(selectedValue)]="field.name"
                placeholder="Alan adÄ± seÃ§in">
              </app-select>
            </div>
            <div class="field-mapping-item">
              <label>Pozisyon:</label>
              <input 
                pInputText 
                type="number" 
                [(ngModel)]="field.index" 
                class="w-full">
            </div>
            <div class="field-mapping-item">
              <label>Tip:</label>
              <app-select                title=""
                [itemListDto$]="fieldTypes$"
                [(selectedValue)]="field.type"
                placeholder="Veri tipi seÃ§in">
              </app-select>
            </div>
            <div class="field-mapping-action">
              <button 
                pButton 
                icon="pi pi-times" 
                class="p-button-rounded p-button-danger p-button-sm"
                (click)="removeFieldMapping(i)">
              </button>
            </div>
          </div>
        </div>
      </p-tabPanel>

      <!-- Åablonlar -->
      <p-tabPanel header="HazÄ±r Åablonlar">
        <div class="template-selector">
          <div class="template-info">
            <p>CihazÄ±nÄ±z iÃ§in Ã¶nceden hazÄ±rlanmÄ±ÅŸ ÅŸablonlardan birini seÃ§erek hÄ±zlÄ±ca baÅŸlayabilirsiniz.</p>
            
            <!-- Ã–nerilen Åablonlar -->
            <div *ngIf="getRecommendedTemplates().length > 0" class="recommended-templates">
              <h4>ğŸ“ {{firmaCihaz?.firmaCihazTipKodDto?.kisaAd}} Cihazlar Ä°Ã§in Ã–nerilen Åablonlar</h4>
              <div class="template-grid">
                <div 
                  *ngFor="let template of getRecommendedTemplates()" 
                  class="template-card recommended"
                  [class.selected]="selectedTemplate?.templateName === template.templateName"
                  (click)="selectTemplate(template)">
                  <div class="template-header">
                    <h5>{{template.templateName}}</h5>
                    <span class="device-badge">{{template.deviceBrand}}</span>
                  </div>
                  <p class="template-description">{{template.description}}</p>
                  <div class="template-details">
                    <small>
                      <strong>Delimiter:</strong> {{template.logDelimiter}} | 
                      <strong>Tarih:</strong> {{template.logDateFormat}} | 
                      <strong>Saat:</strong> {{template.logTimeFormat}}
                    </small>
                  </div>
                </div>
              </div>
            </div>

            <!-- TÃ¼m Åablonlar -->
            <div class="all-templates">
              <h4>ğŸ“š TÃ¼m Åablonlar</h4>
              <div class="template-filter-tabs">
                <button 
                  type="button"
                  pButton
                  class="p-button-sm"
                  [class.p-button-outlined]="templateFilter !== 'ALL'"
                  (click)="templateFilter = 'ALL'">
                  TÃ¼mÃ¼
                </button>
                <button 
                  type="button"
                  pButton
                  class="p-button-sm"
                  [class.p-button-outlined]="templateFilter !== 'PDKS'"
                  (click)="templateFilter = 'PDKS'">
                  PDKS
                </button>
                <button 
                  type="button"
                  pButton
                  class="p-button-sm"
                  [class.p-button-outlined]="templateFilter !== 'ALARM'"
                  (click)="templateFilter = 'ALARM'">
                  Alarm
                </button>
                <button 
                  type="button"
                  pButton
                  class="p-button-sm"
                  [class.p-button-outlined]="templateFilter !== 'KAMERA'"
                  (click)="templateFilter = 'KAMERA'">
                  Kamera
                </button>
              </div>

              <div class="template-grid">
                <div 
                  *ngFor="let template of getFilteredTemplates()" 
                  class="template-card"
                  [class.selected]="selectedTemplate?.templateName === template.templateName"
                  (click)="selectTemplate(template)">
                  <div class="template-header">
                    <h5>{{template.templateName}}</h5>
                    <span class="device-badge" [class]="'badge-' + template.deviceType.toLowerCase()">
                      {{template.deviceType}}
                    </span>
                  </div>
                  <p class="template-description">{{template.description}}</p>
                  <div class="template-details">
                    <small>
                      <strong>Marka:</strong> {{template.deviceBrand}} | 
                      <strong>Delimiter:</strong> {{template.logDelimiter}} | 
                      <strong>Format:</strong> {{template.logDateFormat}}
                    </small>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- SeÃ§ilen Åablon Bilgisi -->
            <div *ngIf="selectedTemplate" class="selected-template-info">
              <h4>âœ… SeÃ§ilen Åablon: {{selectedTemplate.templateName}}</h4>
              <p>{{selectedTemplate.description}}</p>
              <button 
                type="button"
                pButton 
                label="Åablonu Uygula"
                icon="pi pi-check"
                class="p-button-success p-button-sm"
                (click)="applyTemplate(selectedTemplate)">
              </button>
              <button 
                type="button"
                pButton 
                label="SeÃ§imi Temizle"
                icon="pi pi-times"
                class="p-button-text p-button-sm"
                (click)="selectedTemplate = null">
              </button>
            </div>
          </div>
        </div>
      </p-tabPanel>

      <!-- Test -->
      <p-tabPanel header="Log Parser Test">
        <div class="test-section">
          <div class="form-row">
            <div class="form-item full-width">
              <label>Ã–rnek Log Verisi:</label>
              <textarea 
                pInputTextarea 
                [(ngModel)]="logParserSampleData" 
                rows="5" 
                style="width: 100%" 
                placeholder="Buraya test etmek istediÄŸiniz log satÄ±rlarÄ±nÄ± girin...">
              </textarea>
            </div>
          </div>
          
          <div class="form-actions">
            <button 
              pButton 
              type="button" 
              label="Test Et" 
              icon="pi pi-check"
              [loading]="isTesting"
              (click)="testLogParserConfig()"
              class="p-button-success">
            </button>
          </div>
          
          <div *ngIf="testResult" class="test-result mt-3">
            <h4>Test Sonucu:</h4>
            <p [class.success]="testResult.success" [class.error]="!testResult.success">
              {{ testResult.message }}
            </p>
            
            <div *ngIf="testResult.success && testResult.parsedData" class="parsed-data">
              <h5>Parse EdilmiÅŸ Veri:</h5>
              <pre>{{ testResult.parsedData | json }}</pre>
            </div>
          </div>
        </div>
      </p-tabPanel>

      <!-- JSON KonfigÃ¼rasyon -->
      <p-tabPanel header="JSON KonfigÃ¼rasyon">
        <div class="json-config">
          <p class="help-text">
            Bu sekme, yapÄ±landÄ±rdÄ±ÄŸÄ±nÄ±z log parser ayarlarÄ±nÄ±n JSON formatÄ±nÄ± gÃ¶sterir. 
            Bu JSON, loglama sisteminde kullanÄ±lacak olan yapÄ±landÄ±rma dosyasÄ±dÄ±r.
          </p>
          
          <pre>{{ jsonConfig }}</pre>
        </div>
      </p-tabPanel>
    </p-tabView>

    <!-- Kaydet Butonu -->
    <div class="form-actions">
      <button 
        pButton 
        type="button" 
        label="Kaydet" 
        icon="pi pi-save"
        [loading]="isSaving"
        (click)="saveLogParserConfig()"
        class="p-button-primary">
      </button>
    </div>
  </div>
</div>
